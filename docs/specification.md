# かるた大会運営支援アプリケーション "Karuta Tournament Manager" 仕様書

本ドキュメントは、これまでの議論を踏まえた形で「かるた大会運営支援アプリケーション群」の要件および仕様をまとめたものです。  
大会運営の効率化および人的ミスの削減を目的とし、**HTML＋JavaScript**（バックエンドレス）で動作するWebアプリケーションとして開発します。

- [1. プロジェクト概要](#1-プロジェクト概要)
  - [1.1. 目的](#11-目的)
  - [1.2. 想定する大会・利用状況](#12-想定する大会利用状況)
  - [1.3. 競技規程への対応](#13-競技規程への対応)
  - [1.4. 対応プラットフォーム・動作環境](#14-対応プラットフォーム動作環境)
  - [1.5. 対象ユーザ](#15-対象ユーザ)
  - [1.6. リリーススケジュール](#16-リリーススケジュール)
- [2. システム構成と全体フロー](#2-システム構成と全体フロー)
  - [2.1. アプリケーション構成](#21-アプリケーション構成)
  - [2.2. 全体的な運用フロー](#22-全体的な運用フロー)
  - [2.3. 2.3 ファイル構造](#23-23-ファイル構造)
- [3. 主要ツールごとの仕様](#3-主要ツールごとの仕様)
  - [3.1. 対戦組み合わせ決定ツール](#31-対戦組み合わせ決定ツール)
  - [3.2. 対戦結果入力ツール](#32-対戦結果入力ツール)
  - [3.3. 総合結果作成ツール](#33-総合結果作成ツール)
- [4. CSVフォーマットとサンプル](#4-csvフォーマットとサンプル)
  - [4.1. 参加者名簿CSVサンプル](#41-参加者名簿csvサンプル)
  - [4.2. 出力ファイル例](#42-出力ファイル例)
- [5. 組み合わせアルゴリズム（変更不可）](#5-組み合わせアルゴリズム変更不可)
  - [5.1. 概要](#51-概要)
- [6. UI/UX・運用関連](#6-uiux運用関連)
  - [6.1. UIレイアウト](#61-uiレイアウト)
  - [6.2. 印刷・画像出力](#62-印刷画像出力)
  - [6.3. 運営フロー・ファイル管理](#63-運営フローファイル管理)
  - [6.4. 開発体制・保守](#64-開発体制保守)
- [7. 今後の懸案・確認事項](#7-今後の懸案確認事項)

---

## 1. プロジェクト概要

### 1.1. 目的

- かるた大会の運営をデジタル化し、**人的ミスの削減**と**作業工数の軽減**を図る。
- **複数試合・多クラス**のトーナメント管理をシンプルかつ正確に行えるようにする。

### 1.2. 想定する大会・利用状況

- トーナメント形式（上限64名を1クラスとし、10クラス程度の規模）。  
- **トーナメント＋敗者同士の交流戦**を平行運用。  
  - 本戦で1度負けた選手は、次ラウンドから交流戦に参加。  
  - 交流戦の成績は本戦の優勝・順位には反映しないが、対戦結果としては記録する。

### 1.3. 競技規程への対応

- **全日本かるた協会の競技規程および競技会規程**に則る。  

### 1.4. 対応プラットフォーム・動作環境

- **HTML + JavaScriptのみ**で完結。  
- バックエンド不要、**オフライン運用可**。
- データは**CSVファイル**で読み書きする。

### 1.5. 対象ユーザ

- 大会運営スタッフ（入力端末は当面1台想定、将来的に複数端末対応の可能性あり）。
- 参加者へは、**組み合わせ表・試合結果**をCSV、PNGとして提供。

### 1.6. リリーススケジュール

- 1週間で完成を目標に開発。  
- 総合結果作成ツール（PDF出力等）は後回しでもよい。まずはCSV出力のみを優先。

---

## 2. システム構成と全体フロー

### 2.1. アプリケーション構成

1. **対戦組み合わせ決定ツール**  
   - 参加者CSVを読み込み、`generatePairs()` 関数を用いて**対戦組み合わせを自動生成**。  
   - 出力：組み合わせCSV、PNG（表形式）、画面表示。

2. **対戦結果入力ツール**  
   - 組み合わせCSVを参照しながら、**勝敗・枚差**などの試合結果を入力。  
   - 出力：試合結果CSV、次ラウンド用参加者CSV、PNG（結果表）、画面表示。  
   - 勝者のみが次ラウンドへ進み、敗者は**交流戦**の仕組みも別途考慮。

3. **総合結果作成ツール**  
   - 各ラウンドの結果CSVを取り込み、**最終的な成績表（allMatchResult.csv）**を作成。  
   - トーナメントの場合、全勝者が複数名いる場合は**全員優勝**とする。  
   - **PDF出力**は二次開発。またはライブラリ利用（pdfmake, jsPDF等）で実装を検討。

### 2.2. 全体的な運用フロー

1. **大会開始**  
   - 参加者CSV（例：`1stPlayers.csv`）を用意し、欠席者・敗退者（初期はなし）のフラグを確認。

2. **1回戦の対戦組み合わせ**（対戦組み合わせ決定ツール）  
   - CSV読み込み → `generatePairs()` 関数を実行 → `1stMatch.csv`（組み合わせ一覧）、`1stMatch.png`（表形式）を出力。

3. **1回戦結果の入力**（対戦結果入力ツール）  
   - `1stMatch.csv` を参照して**勝敗・枚差**を入力。  
   - `1stResult.csv`（結果一覧）、`2ndPlayers.csv`（次ラウンドで用いる名簿）を出力。  

4. **2回戦の対戦組み合わせ**  
   - `2ndPlayers.csv` を再度読み込み → 組み合わせ決定 → `2ndMatch.csv` 出力。
   - 敗者は本戦から除外→交流戦に回る（実装詳細は後述）。

5. **2回戦結果の入力**  
   - `2ndMatch.csv` → `2ndResult.csv`, `3rdPlayers.csv`  
   - …（ラウンド分繰り返し）…

6. **最終ラウンド終了**  
   - `nthResult.csv` を出力。

7. **総合結果作成**（総合結果作成ツール）  
   - `1stResult.csv` ～ `nthResult.csv` を統合 → `allMatchResult.csv`  
   - **「優勝」「準優勝」「ベスト4」**などを付与。  
   - 交流戦の結果も同一ファイルに種別欄などで記録（最終成績には反映しない）。

### 2.3. 2.3 ファイル構造

```text
karuta-tournament-manager/   <-- レポジトリのルート
├─ docs/
│   ├─ specification.md      <-- 仕様書(今回の修正版仕様書など)
│   ├─ manual.md             <-- 利用マニュアル(操作手順書)
│   └─ ...                  <-- その他資料・設計ドキュメント
├─ src/
│   ├─ index.html           <-- メイン画面 / メニュー画面など
│   ├─ css/
│   │   └─ style.css        <-- 共通スタイルシート
│   ├─ js/
│   │   ├─ main.js          <-- エントリーポイント。画面操作のメインロジック
│   │   ├─ generatePairs.js <-- 組み合わせアルゴリズム (変更不可の既存実装)
│   │   ├─ resultInput.js   <-- 対戦結果入力周りのロジック
│   │   ├─ outputCsv.js     <-- CSV出力などのユーティリティ
│   │   └─ ...
│   ├─ img/
│   │   └─ (PNG出力サンプルやUI用画像を保存してもOK)
│   └─ sampleData/
│       ├─ participants_sample.csv  <-- 参加者リストサンプル
│       ├─ ...
│       └─ readme.md               <-- サンプルデータの簡易説明
├─ .gitignore
├─ README.md                <-- レポジトリのトップに表示される説明(導入方法など)
└─ LICENSE (もし公開ライセンスを設定するなら)
```

---

## 3. 主要ツールごとの仕様

### 3.1. 対戦組み合わせ決定ツール

- **入力データ**  
  - 参加者CSV  
    - カラム例: ID, 級, 組, 姓, 名, 姓読み, 名読み, 所属, 欠席, 敗退, 交流戦不参加  
      - 級(rank)と組(group)のセットを「級組(rankGroup)」と呼ぶ。
        - 例 D級2組の場合、クラスはD2。
    - 欠席がTRUEの場合は除外。敗退列がある場合はTRUEなら本戦からは除外し、交流戦に参加させる。ただし交流戦不参加の場合は除外。  

- **フロー**
  1. 級組ごとに、本戦の対戦を競技会規程準拠組合せアルゴリズムを用いて決定する。
  2. 級ごとに、

- **競技会規程準拠組合せアルゴリズム：generatePairs関数（変更不可）**  
  1. 欠席・敗退を除外  
  2. 不戦勝数を決定
  3. 競技会規程に則り同所属対戦を回避しつつ、どうしても避けられない場合は許容  
  4. `[ [選手A, 選手B], [選手C, 選手D], …]` の形式で返却  
  5. 不戦勝は `[ 選手X, 選手Y, …]` として返却

- **出力**  
  1. **組み合わせCSV** (例: `nMatch.csv`)  
     - 左席番号/ID/名前/所属、右席番号/ID/名前/所属、不戦勝フラグ、敗退済みフラグ、交流戦フラグ、試合なしフラグ
     - フラグの運用は下記表を参照
     - 対戦ありが`FALSE`である選手は、左席に並べる(右席は空欄)
  2. **組み合わせPNG**  
     - シンプルな表形式を Canvas 等で描画し、画像化。  
     - **左席番号・左名前(フリガナ)・左所属**｜**右席番号・右名前(フリガナ)・右所属** の列で表示  
     - 本戦と交流戦は別の表で出力する。
  3. **HTML表示**  
     - ブラウザ上で確認・印刷できる。

| パターン                       | 敗退済み | 不戦勝  | 交流戦  | 対戦あり |
| :----------------------------- | :------- | :------ | :------ | :------- |
| 本戦対戦                       | `FALSE`  | `FALSE` | `FALSE` | `TRUE`   |
| 本戦不戦勝(休み)               | `FALSE`  | `TRUE`  | `FALSE` | `FALSE`  |
| 本戦不戦勝かつ交流戦           | `FALSE`  | `TRUE`  | `TRUE`  | `TRUE`   |
| 本戦敗退かつ交流戦             | `TRUE`   | `FALSE` | `TRUE`  | `TRUE`   |
| 本戦敗退かつ交流戦不戦勝(休み) | `TRUE`   | `FALSE` | `TRUE`  | `FALSE`  |
| 本戦敗退かつ交流戦辞退         | `TRUE`   | `FALSE` | `FALSE` | `FALSE`  |
| 欠席                           | `TRUE`   | `FALSE` | `FALSE` | `FALSE`  |

### 3.2. 対戦結果入力ツール

- **入力**  
  - 前ツールで生成した `nMatch.csv`  
  - ユーザが**席番号順**に「勝者（○/×）・枚差」を入力するUIを提供

- **出力**  
  1. **対戦結果CSV** (例: `nResult.csv`)  
     - (級、組、席番号、左ID／名前、右ID／名前、勝者、枚差、…など)  
     - **勝敗表記は「○/×」**とする  
  2. **次ラウンド用参加者CSV** (例: `(n+1)thPlayers.csv`)  
     - 選手ID順に並べる
     - カラム: ID, 級, 組, 姓, 名, 姓読み, 名読み, 所属, 欠席, 敗退, 交流戦不参加  
     - 敗者は`敗退済み = TRUE`にするなどフラグ管理  
     - 交流戦参加を希望しない選手は`交流戦 = FALSE`にする  
       - 交流戦参加を希望しない選手はHTML上で入力可能
  3. **結果PNG**
     - 対戦組み合わせ同様、表形式でエクスポート可能

- **操作イメージ**  

  | 左席番号 | 左名前 | 左所属 | 右席番号 | 右名前 | 右所属 |             勝者             | 枚差(数値) |
  | :------: | :----: | :----: | :------: | :----: | :----: | :--------------------------: | :--------: |
  |  (自動)  | (自動) | (自動) |  (自動)  | (自動) | (自動) | (プルダウン、左名前・右名前) |  (入力UI)  |

### 3.3. 総合結果作成ツール

- **入力**  
  - 各ラウンドの結果CSV (`1stResult.csv`, `2ndResult.csv`, … `nthResult.csv`)

- **出力**  
  - **allMatchResult.csv**  
    - 選手ごとに「1回戦成績／種別／相手／対戦結果（○/×）／枚差」…と横に並べる  
    - ラウンド数が増えるほど列が増加（5列／ラウンド）  
    - 最終列に「優勝」「準優勝」「ベスト4」などの最終成績  
  - **PDF**（後回し）  
    - CSVを元に表形式をPDF化。ライブラリ（pdfmake, jsPDF等）を使用予定。

- **交流戦の扱い**  
  - 同じラウンドのカラムに「種別 = 交流戦」として区別し、対戦結果は記録するが優勝決定には関わらない  
  - 例：`1回戦種別 = '不戦勝 交流戦'`, `1回戦対戦結果 = '○'`, 等々

---

## 4. CSVフォーマットとサンプル

### 4.1. 参加者名簿CSVサンプル

```csv
ID, 級, 組, 姓, 名, 姓読み, 名読み, 所属, 欠席, 敗退, 交流戦不参加  
101 ,D ,1 ,青嶋 ,あおい ,あおしま ,あおい ,大阪むらさめの会 ,FALSE, FALSE, FALSE
102 ,D ,1 ,権藤 ,海透 ,ごんどう ,かいと ,新東名大学 ,FALSE, TRUE, FALSE
...
432 ,E ,2 ,佐野 ,直哉 ,さの ,なおや ,有馬中央東高校 ,FALSE, FALSE, FALSE
```

- 主なカラム例
  - Id：ユニークID
  - 級：A, B, C, D, E など
  - 組：1, 2 …
  - 姓, 名：分割して記録（もしくは1項目でも可）
  - 姓読み, 名読み：フリガナ
  - 所属：チームや学校名
  - 欠席： "TRUE"/"FALSE" で欠席かどうか
  - 敗退： "TRUE"/"FALSE" 既に敗退しているか
  - 交流戦不参加： "TRUE"/"FALSE" 交流戦に参加しないかどうか
- 複数クラス混在
  - D1, D2, E1, E2 などが同一CSVに入っている場合、ツール側で級や組をフィルタして組み合わせを生成する、もしくは1つの大きなトーナメントにまとめるなどの運用が考えられる。

### 4.2. 出力ファイル例

- 対戦組み合わせCSV (例: 1stMatch.csv)

| 席番号 | 左ID | 左名前 | 左所属 | 席番号 | 右ID | 右名前 | 右所属 | 不戦勝 |
| ------ | ---- | ------ | ------ | ------ | ---- | ------ | ------ | ------ |

- 対戦結果CSV (例: 1stResult.csv)

| 席番号 | 左ID | 左名前     | 左所属           | 席番号 | 右ID | 右名前   | 右所属     | 勝者ID | 枚差 |
| ------ | ---- | ---------- | ---------------- | ------ | ---- | -------- | ---------- | ------ | ---- |
| 1      | 101  | 青嶋あおい | 大阪むらさめの会 | 2      | 102  | 権藤海透 | 新東名大学 | 101    | 5    |

- 最終結果(allMatchResult.csv)
  
| No. | 所属 | 氏名 | 1回戦成績 | 1回戦種別 | 1回戦相手 | 1回戦対戦結果(○/×) | 1回戦枚差 | 2回戦成績 | 2回戦種別 | 2回戦相手 | 2回戦対戦結果(○/×) | 2回戦枚差 | …   | 最終成績 |
| --- | ---- | ---- | --------- | --------- | --------- | ------------------ | --------- | --------- | --------- | --------- | ------------------ | --------- | --- | -------- |

- ファイル入出力ルール
  - 文字コード：UTF-8(BOM付き) で出力（Shift_JIS 等での入力も受け付ける）
  - 区切り文字：,（カンマ）
  - 必須カラム：Id, 級, 所属, および 名前(または 姓+名)
  - その他カラムは任意

## 5. 組み合わせアルゴリズム（変更不可）

### 5.1. 概要

```js
function generatePairs(data, shuffleFn = shuffle) {
  // (1) 欠席・敗退のプレイヤーを除外
  // (2) シャッフル
  // (3) 不戦勝数を決定し、ランダムに不戦勝を割り当て
  // (4) 所属が同じにならないよう左・右に振り分ける。どうしても回避できなければ許容
  // (5) 対戦の一覧pairs, 不戦勝者の一覧walkovers を返す
}
```

同所属対戦回避が入っているが、調整できない場合は許容。
本ロジックを変更することは許容されない。（競技会規程に合致）

## 6. UI/UX・運用関連

### 6.1. UIレイアウト

- 具体的なワイヤーフレームはまだ決定していない。
- 画面の大まかな構成のみ：
  - CSV読み込みボタン、組み合わせ生成ボタン、結果入力用テーブル、PNG出力ボタンなどを配置予定。
- 視覚障害対応やカラーユニバーサルデザインは必須ではないが、シンプルで分かりやすいUIを心がける。

### 6.2. 印刷・画像出力

- 印刷用レイアウトは必須ではない。
- PNG出力（対戦表・結果表）を選手のスマホに送る運用を想定している。
  - フォントサイズや表幅はスマホでも見やすいよう配慮（A4最適化は不要）。

### 6.3. 運営フロー・ファイル管理

- 基本的に大会運営スタッフがローカルPCでCSVを編集・更新。
- 複数クラスが混在する場合は、級・組でフィルタ分割し、ラウンドごとに別々のCSVを生成（(n+1)thPlayers.csv, …）
- 将来的に複数端末で同時入力する要望があれば、クラウド同期等を検討する。

### 6.4. 開発体制・保守

- 個人開発かつ GitHub でバージョン管理。
- 一般ユーザサポートは行わず、運営スタッフとは個別にやりとり可能。
- 大会名・配色切り替え等は、HTML/JSを直接編集して対応。

## 7. 今後の懸案・確認事項

- ワイヤーフレームの詳細
  - 画面UIのボタン配置やテーブル項目などを、最終的にどのようにするか。
  - 共有の際は、できれば文字情報中心（図示や箇条書き）で説明いただけると反映しやすい。

- 交流戦のCSV取り扱い
  - 本戦と同じCSVで扱う場合、「ラウンド種別 = 交流戦」として記録。
  - あるいは別ファイルを用意するかは最終検討（サンプルでは同一ファイルで種別で区別）。

- 敗退フラグ
  - 現状のサンプルCSVでは 敗退 カラムがない場合もある。
  - 今後のツール運用で敗退者を更新する場合は、列追加 or ツール内のメモリ管理が必要。

- 最大試合数・出力列数
  - 同じフォーマットで 1回戦 ~ N回戦 × 5列 を追加するスタイル。
  - 6回戦以上になると列が増えて横に長くなる点に注意。

- PDF出力の優先度
  - 二次開発で対応する方針。
  - 当面はCSV出力を確実に行うことを優先。
